name: PickLab BE Deploy Workflow

on:
  workflow_run:
    workflows:
      - 'PickLab BE Integration Workflow'
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
      tags:
        description: 'Test tags'

permissions:
  contents: read
  packages: write

jobs:
  docker-build-push:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    name: Create Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker Image with Gradle
        run: |
          ./gradlew bootBuildImage \
          --imageName=ghcr.io/${{ github.repository_owner }}/picklab-be:${{ github.sha }}

      - name: Tag as latest
        run: |
          docker tag ghcr.io/${{ github.repository_owner }}/picklab-be:${{ github.sha }} \
                  ghcr.io/${{ github.repository_owner }}/picklab-be:latest

      - name: Push Docker Images to GitHub Container Registry
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/picklab-be:${{ github.sha }}
          docker push ghcr.io/${{ github.repository_owner }}/picklab-be:latest

  deploy-via-bastion:
    needs: docker-build-push
    name: Deploy via Bastion
    runs-on: ubuntu-latest

    env:
      OCI_CLI_USER: ${{ secrets.OCI_USER_OCID }}
      OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY_OCID }}
      OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
      OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_PRIVATE_KEY }}
      OCI_CLI_REGION: us-phoenix-1

    steps:
      - name: Install OCI CLI
        run: |
          curl -L -O https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh
          chmod +x install.sh
          ./install.sh --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

      - name: Setup SSH
        run: |
          ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa -q -N ""
          chmod 600 ~/.ssh/id_rsa

      - name: Create Managed SSH Session
        run: |
          echo "Creating bastion managed SSH session..."
          oci bastion session create-managed-ssh \
            --bastion-id ${{ secrets.OCI_BASTION_OCID }} \
            --display-name "github-deploy-${{ github.run_id }}" \
            --ssh-public-key-file ~/.ssh/id_rsa.pub \
            --key-type PUB \
            --target-resource-id ${{ secrets.OCI_INSTANCE_OCID }} \
            --target-os-username ubuntu \
            --session-ttl 10800 > ~/bastion_session.json

          SESSION_ID=$(jq -r '.data.id' ~/bastion_session.json)
          echo "Session ID: $SESSION_ID"

          for i in {1..60}; do
            STATE=$(oci bastion session get \
              --session-id $SESSION_ID \
              --query 'data."lifecycle-state"' \
              --raw-output)

            echo "Attempt $i/60: $STATE"

            if [ "$STATE" = "ACTIVE" ]; then
              echo "✓ Session active"
              break
            fi

            if [ $i -eq 60 ]; then
              echo "✗ Timeout"
              exit 1
            fi

            sleep 5
          done

          echo "bastion_session_ocid=$SESSION_ID" >> "$GITHUB_ENV"

      - name: Deploy Application
        run: |
          GITHUB_USER="${{ github.actor }}"
          GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          GITHUB_REPO="${{ github.repository_owner }}"
          IMAGE_TAG="${{ github.sha }}"
          
          ssh -i ~/.ssh/id_rsa \
            -o ProxyCommand="ssh -i ~/.ssh/id_rsa -W %h:%p -p 22 -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ env.bastion_session_ocid }}@host.bastion.us-phoenix-1.oci.oraclecloud.com" \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -p 22 \
            ubuntu@${{ secrets.OCI_INSTANCE_PRIVATE_IP }} << ENDSSH
          
          set -e
          
          echo '${GITHUB_TOKEN}' | sudo docker login ghcr.io \
            -u ${GITHUB_USER} --password-stdin
          
          APP_NAME=picklab-be
          DOCKER_REPO=ghcr.io/${GITHUB_REPO}/picklab-be
          IMAGE_TAG=${IMAGE_TAG}
          
          sudo docker stop \$APP_NAME || true
          sudo docker rm \$APP_NAME || true
          sudo docker image prune -f
          sudo docker pull \$DOCKER_REPO:\$IMAGE_TAG
          
          sudo docker run -d --name \$APP_NAME \
            -v /etc/localtime:/etc/localtime:ro \
            -e TZ=Asia/Seoul \
            -e SPRING_PROFILES_ACTIVE=prod \
            -p 8080:8080 \
            --memory=1g --memory-swap=1g \
            \$DOCKER_REPO:\$IMAGE_TAG
          ENDSSH
      - name: Cleanup Bastion Session
        if: always()
        run: |
          if [ -n "${{ env.bastion_session_ocid }}" ]; then
            oci bastion session delete \
              --session-id ${{ env.bastion_session_ocid }} \
              --force || true
          fi

  notify-deploy-statement:
    name: Discord Notification for Deployment Result
    runs-on: ubuntu-latest
    needs: [ docker-build-push, deploy-via-bastion ]
    if: always()
    steps:
      - name: Notify Discord
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DEPLOY_WEBHOOK_URL }}
          status: ${{ job.status }}
          title: "PickLab BE 배포 (OCI via Bastion)"
          description: |
            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Target: OCI Compute Instance
            ${{ needs.deploy-via-bastion.result == 'success' && '✅ 배포 성공!' || '❌ 배포 실패!' }}